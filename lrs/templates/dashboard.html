{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Dashboard - xAPI LRS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h1 class="h2 mb-2">
                        <span class="gradient-text">xAPI Learning Record Store</span>
                    </h1>
                    <p class="text-muted">Manage and monitor your learning analytics</p>
                </div>
                <div class="text-end">
                    {% bootstrap_button "Quick Setup" button_type="button" button_class="btn-gradient btn-lg" onclick="window.location.href='/moodle-manager/'" icon="plus-circle" %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Copy Section for Moodle Plugin -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient-to-r from-success to-teal">
                <div class="card-body text-white">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div>
                            <h5 class="mb-1">
                                <i class="bi bi-clipboard-check-fill me-2"></i>
                                Moodle Plugin Configuration
                            </h5>
                            <p class="mb-0 text-white-80">Copy these values to configure your Moodle xAPI Bridge plugin</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-white text-success mb-2">Ready to Copy</span>
                            <div>
                                {% bootstrap_button "Full Configuration" button_type="link" button_class="btn-sm btn-light" href="/config/" %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="bg-white bg-opacity-10 rounded p-3">
                                <div class="small mb-2 fw-semibold">üîó LRS Endpoint URL</div>
                                <div class="bg-white rounded p-2 mb-2">
                                    <div class="small text-muted mb-1">Setting Name:</div>
                                    <code class="text-primary font-mono small">{{ moodle_config.lrs_endpoint.name }}</code>
                                </div>
                                <div class="bg-white rounded p-2 mb-2">
                                    <div class="small text-muted mb-1">Value to Copy:</div>
                                    <code class="text-primary font-mono small">{{ moodle_config.lrs_endpoint.value }}</code>
                                </div>
                                <button onclick="copyToClipboard('quick-endpoint')" class="btn btn-sm btn-light w-100">
                                    <i class="bi bi-clipboard me-1"></i>Copy Endpoint URL
                                </button>
                                <input type="hidden" id="quick-endpoint" value="{{ moodle_config.lrs_endpoint.value }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-white bg-opacity-10 rounded p-3">
                                <div class="small mb-2 fw-semibold">üîë Authentication Token</div>
                                <div class="bg-white rounded p-2 mb-2">
                                    <div class="small text-muted mb-1">Setting Name:</div>
                                    <code class="text-warning font-mono small">{{ moodle_config.lrs_auth_token.name }}</code>
                                </div>
                                <div class="bg-white rounded p-2 mb-2">
                                    <div class="small text-muted mb-1">Value to Enter:</div>
                                    <code class="text-warning font-mono small">
                                        {% if auth_status == 'Configured' %}
                                            Your configured token
                                        {% else %}
                                            {{ moodle_config.lrs_auth_token.value }}
                                        {% endif %}
                                    </code>
                                </div>
                                <button onclick="copyToClipboard('quick-token-info')" class="btn btn-sm btn-light w-100">
                                    <i class="bi bi-clipboard me-1"></i>Copy Token Info
                                </button>
                                <input type="hidden" id="quick-token-info" value="{% if auth_status == 'Configured' %}Your configured token{% else %}{{ moodle_config.lrs_auth_token.value }}{% endif %}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-white bg-opacity-10 rounded p-3">
                                <div class="small mb-2 fw-semibold">‚öôÔ∏è Enable Plugin</div>
                                <div class="bg-white rounded p-2 mb-2">
                                    <div class="small text-muted mb-1">Setting Name:</div>
                                    <code class="text-success font-mono small">{{ moodle_config.enabled.name }}</code>
                                </div>
                                <div class="bg-white rounded p-2 mb-2">
                                    <div class="small text-muted mb-1">Value to Select:</div>
                                    <code class="text-success font-mono small">{{ moodle_config.enabled.value }}</code>
                                </div>
                                <button onclick="copyToClipboard('quick-enabled')" class="btn btn-sm btn-light w-100">
                                    <i class="bi bi-clipboard me-1"></i>Copy Setting Name
                                </button>
                                <input type="hidden" id="quick-enabled" value="{{ moodle_config.enabled.name }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <div class="alert alert-light bg-white bg-opacity-20 border-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Setup Instructions:</strong> Navigate to <strong>Moodle Admin ‚Üí Site administration ‚Üí Plugins ‚Üí Local plugins ‚Üí xAPI Bridge</strong> and configure these settings.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LRS Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card hover-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-2">
                                <i class="bi bi-file-text text-primary"></i>
                            </div>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Total Statements</h6>
                            <div class="h3 mb-0">{{ stats.total_statements }}</div>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> 12% from last week
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card hover-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                <i class="bi bi-people text-success fs-4"></i>
                            </div>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Active Learners</h6>
                            <div class="h3 mb-0">{{ stats.total_actors }}</div>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> 8% from last week
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card hover-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                <i class="bi bi-book text-info fs-4"></i>
                            </div>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Courses</h6>
                            <div class="h3 mb-0">{{ stats.total_activities }}</div>
                            <small class="text-muted">
                                <i class="bi bi-dash"></i> No change
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card hover-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                                <i class="bi bi-graph-up text-warning fs-4"></i>
                            </div>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Total Verbs</h6>
                            <div class="h3 mb-0">{{ stats.total_verbs }}</div>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> 3% from last week
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Statements -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">Recent Learning Activities</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Learner</th>
                                    <th>Activity</th>
                                    <th>Action</th>
                                    <th>Time</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for statement in recent_statements %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-2">
                                                <i class="bi bi-person-fill text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="fw-semibold">{{ statement.actor_name }}</div>
                                                <small class="text-muted">{{ statement.actor_email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="fw-semibold">{{ statement.activity_name }}</div>
                                            <small class="text-muted">{{ statement.activity_type }}</small>
                                        </div>
                                    </td>
                                    <td><span class="badge {% if statement.result_completion %}bg-success{% else %}bg-info{% endif %}">{{ statement.verb_display }}</span></td>
                                    <td><small class="text-muted">{{ statement.timestamp|date:"H:i" }} ago</small></td>
                                    <td>
                                        {% if statement.result_score %}
                                            <span class="badge bg-primary">{{ statement.result_score }}%</span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="bi bi-info-circle me-2"></i>
                                            No learning activities recorded yet
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary d-flex align-items-center justify-content-start" onclick="window.location.href='/moodle-manager/'">
                            <i class="bi bi-cloud-arrow-up me-1"></i>
                            Manage Moodle Instances
                        </button>
                        <button class="btn btn-outline-success d-flex align-items-center justify-content-start" onclick="window.location.href='/web-services/'">
                            <i class="bi bi-gear-wide-connected me-1"></i>
                            Web Services
                        </button>
                        <button class="btn btn-outline-info d-flex align-items-center justify-content-start" onclick="generateDashboardReport()">
                            <i class="bi bi-graph-up me-1"></i>
                            Generate Report
                        </button>
                        <button class="btn btn-outline-warning d-flex align-items-center justify-content-start" onclick="window.location.href='/admin/'">
                            <i class="bi bi-gear me-1"></i>
                            Admin Dashboard
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Moodle Integrations -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">Moodle Integrations</h5>
                        <a href="/moodle-manager/" class="btn btn-sm btn-primary" title="Manage Moodle Integrations">
                            <i class="bi bi-gear"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush" id="moodleIntegrationsList">
                        <!-- Moodle integrations will be loaded here -->
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            Loading Moodle integrations...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load Moodle integrations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMoodleIntegrations();
});

async function loadMoodleIntegrations() {
    const listContainer = document.getElementById('moodleIntegrationsList');
    
    try {
        const response = await fetch('/api/moodle-integrations/');
        
        if (response.ok) {
            const integrations = await response.json();
            renderMoodleIntegrations(integrations);
        } else {
            throw new Error('Failed to load integrations');
        }
    } catch (error) {
        console.error('Error loading Moodle integrations:', error);
        
        // Show error state
        listContainer.innerHTML = `
            <div class="text-center py-3">
                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                <small class="text-muted">Failed to load integrations</small>
            </div>
        `;
    }
}

function renderMoodleIntegrations(integrations) {
    const listContainer = document.getElementById('moodleIntegrationsList');
    
    if (integrations.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-3">
                <i class="bi bi-cloud-arrow-up text-muted me-2"></i>
                <small class="text-muted">No Moodle integrations configured</small>
                <div class="mt-2">
                    <a href="/moodle-manager/" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>Add Integration
                    </a>
                </div>
            </div>
        `;
        return;
    }
    
    const integrationsHtml = integrations.map(integration => `
        <div class="list-group-item d-flex justify-content-between align-items-center px-0" style="cursor: pointer;" onclick="window.location.href='/moodle-manager/'">
            <div>
                <div class="fw-semibold">${integration.moodle_site_name}</div>
                <small class="text-muted">${integration.moodle_url}</small>
            </div>
            <span class="badge ${integration.is_active ? 'bg-success' : 'bg-secondary'}">
                ${integration.is_active ? 'Active' : 'Inactive'}
            </span>
        </div>
    `).join('');
    
    listContainer.innerHTML = integrationsHtml;
}

async function generateDashboardReport() {
    // Get the button that was clicked (fix event.target issue)
    const button = event && event.target ? event.target.closest('button') : document.querySelector('button[onclick*="generateDashboardReport"]');
    if (!button) {
        showDashboardMessage('Error: Could not find button', 'error');
        return;
    }
    
    const originalContent = button.innerHTML;
    
    try {
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
        button.disabled = true;
        
        // First get Moodle integrations to use for report generation
        const integrationsResponse = await fetch('/api/moodle-integrations/');
        if (!integrationsResponse.ok) {
            throw new Error('Failed to get Moodle integrations');
        }
        
        const integrations = await integrationsResponse.json();
        if (integrations.length === 0) {
            showDashboardMessage('No Moodle integrations found. Please add a Moodle instance first.', 'error');
            return;
        }
        
        // Use the first active integration for report generation
        const integration = integrations.find(i => i.is_active) || integrations[0];
        
        // Generate report using API with required parameters
        const response = await fetch('/api/generate-xapi-reports/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                moodle_url: integration.moodle_url,
                token: integration.moodle_token
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Show success message
            showDashboardMessage(`Successfully generated report with ${result.reports_count || 0} statements`, 'success');
            
            // Offer download
            if (result.download_url) {
                setTimeout(() => {
                    if (confirm('Report generated! Would you like to download the report?')) {
                        window.open(result.download_url, '_blank');
                    }
                }, 1000);
            }
        } else {
            const errorData = await response.json();
            showDashboardMessage(errorData.error || 'Failed to generate report', 'error');
        }
    } catch (error) {
        console.error('Error generating report:', error);
        showDashboardMessage('Failed to generate report: ' + error.message, 'error');
    } finally {
        // Restore button
        if (button) {
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    }
}

function getCsrfToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue || '';
}

function showDashboardMessage(message, type) {
    // Create a toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Add toast and show it
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.value;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            showDashboardMessage('Endpoint URL copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showDashboardMessage('Endpoint URL copied to clipboard!', 'success');
}
</script>

{% endblock %}
