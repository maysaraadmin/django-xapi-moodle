{% extends 'base.html' %}
{% load django_bootstrap5 static %}

{% block title %}Moodle Manager - xAPI LRS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
<!-- Bootstrap 5 CSS enhancement -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<style>
/* Enhanced Bootstrap 5 styles for Moodle Manager */
.hero-section {
    background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%);
    border-radius: 1rem;
    padding: 3rem 0;
    margin-bottom: 2rem;
    color: white;
}

.hero-section h1 {
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.hero-section p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 0;
}

.stats-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    height: 100%;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.stats-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #fff;
}

.stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
    color: rgba(255, 255, 255, 0.9);
}

.instance-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.3s ease;
}

.instance-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.sync-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-align: center;
    height: 100%;
    transition: all 0.3s ease;
}

.sync-card:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transform: translateY(-2px);
}

.sync-icon {
    font-size: 2rem;
    color: #0d6efd;
    margin-bottom: 1rem;
}

.sync-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #495057;
}

.sync-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.instance-status {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-online {
    background-color: #198754;
    color: white;
}

.status-offline {
    background-color: #6c757d;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.action-btn {
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold">
                    <i class="bi bi-cloud-arrow-up me-3"></i>
                    Moodle Manager
                </h1>
                <p class="lead">Advanced xAPI Learning Record Store integration for Moodle</p>
                <div class="mt-4">
                    <div class="d-flex gap-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalInstances">0</div>
                            <div class="stats-label">Moodle Instances</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number" id="activeConnections">0</div>
                            <div class="stats-label">Active Connections</div>
                        </div>
                        <div class="stats-card">
                            <div class="spinner-border spinner-border-sm text-light" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="stats-label">xAPI Statements</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <div class="stats-card">
                    <i class="bi bi-graph-up-arrow fs-1 mb-2"></i>
                    <div class="card bg-white bg-opacity-10 text-white border-0">
                        <div class="card-body text-center">
                            <div class="h2 mb-1" id="totalCourses">0</div>
                            <div class="small">Courses</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">Moodle Instances</h4>
                {% bootstrap_button "Add Instance" button_type="button" button_class="btn-primary" data_bs_toggle="modal" data_bs_target="#addMoodleModal" icon="plus-lg" %}
            </div>
        </div>
    </div>

    <!-- Moodle Instances Grid -->
    <div class="row" id="moodleInstances">
        <!-- Instances will be loaded here via JavaScript -->
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">
            <i class="bi bi-server"></i>
        </div>
        <h4 class="mt-3">No Moodle Instances Connected</h4>
        <p class="text-muted">Connect your first Moodle instance to start managing xAPI data</p>
        {% bootstrap_button "Add Instance" button_type="button" button_class="btn-light btn-lg" data_bs_toggle="modal" data_bs_target="#addMoodleModal" icon="plus-circle" %}
    </div>
</div>

    <!-- Instance Management Section -->
<div id="instanceManagement" style="display: none;">
    <div class="container">
        <!-- Selected Instance Header -->
        <div class="instance-card mb-4">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">
                            <i class="bi bi-server me-2"></i>
                            <span id="selectedInstanceName"></span>
                        </h5>
                        <p class="mb-0 opacity-75">Managing Moodle Instance</p>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="clearSelectedInstance()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label text-muted">Moodle URL</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="selectedInstanceUrl" readonly>
                                <button class="btn btn-outline-secondary" onclick="copyToClipboard(document.getElementById('selectedInstanceUrl').value)">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label text-muted">Connection Status</label>
                            {% bootstrap_button "Test Connection" button_type="button" button_class="btn-primary" id="testConnectionBtn" onclick="testConnection()" icon="plug" %}
                            <span id="testBtnText" class="visually-hidden">Test Connection</span>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Status Display -->
                <div id="connectionStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i id="connectionIcon" class="fs-4"></i>
                            </div>
                            <div>
                                <h6 id="connectionTitle" class="mb-1"></h6>
                                <p id="connectionMessage" class="mb-0"></p>
                                <div id="siteInfo" class="mt-2"></div>
                                <div id="debugInfo" class="mt-3" style="display: none;">
                                    <hr>
                                    <h6 class="text-muted mb-2">Debug Information:</h6>
                                    <div class="small">
                                        <div><strong>Moodle URL:</strong> <span id="debugMoodleUrl"></span></div>
                                        <div><strong>Web Service URL:</strong> <span id="debugWebserviceUrl"></span></div>
                                        <div><strong>Token Provided:</strong> <span id="debugTokenProvided"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LRS Integration Section -->
        <div class="sync-section">
            <div class="d-flex align-items-center mb-4">
                <div class="flex-grow-1">
                    <h4 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        LRS Integration
                    </h4>
                    <p class="text-muted mb-0">Sync Moodle data with xAPI Learning Record Store</p>
                </div>
                <span class="instance-status status-online">Connected</span>
            </div>

            <!-- Sync Actions Grid -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="sync-card">
                        <div class="sync-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <h6 class="sync-title">Sync Users</h6>
                        <p class="sync-description">Import Moodle users as xAPI actors</p>
                        {% bootstrap_button "Sync Users" button_type="button" button_class="btn-success" onclick="syncUsers()" icon="arrow-repeat" %}
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="sync-card">
                        <div class="sync-icon">
                            <i class="bi bi-book-fill"></i>
                        </div>
                        <h6 class="sync-title">Sync Courses</h6>
                        <p class="sync-description">Import Moodle courses as xAPI activities</p>
                        {% bootstrap_button "Sync Courses" button_type="button" button_class="btn-success" onclick="syncCourses()" icon="arrow-repeat" %}
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="sync-card">
                        <div class="sync-icon">
                            <i class="bi bi-list-task"></i>
                        </div>
                        <h6 class="sync-title">Sync Activities</h6>
                        <p class="sync-description">Create xAPI statements from activities</p>
                        {% bootstrap_button "Sync Activities" button_type="button" button_class="btn-success" onclick="syncActivities()" icon="arrow-repeat" %}
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="sync-card">
                        <div class="sync-icon">
                            <i class="bi bi-graph-up"></i>
                        </div>
                        <h6 class="sync-title">Generate Reports</h6>
                        <p class="sync-description">Create comprehensive xAPI reports</p>
                        {% bootstrap_button "Generate Reports" button_type="button" button_class="btn-success" onclick="generateReports()" icon="file-earmark-text" %}
                        {% bootstrap_button "Download Report" button_type="button" button_class="btn-success" onclick="downloadReport()" icon="download" %}
                    </div>
                </div>
            </div>

            <!-- LRS Configuration -->
            <div class="lrs-config">
                <h6 class="mb-3">
                    <i class="bi bi-gear me-2"></i>
                    LRS Configuration
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">LRS Endpoint</label>
                        <input type="text" class="form-control" id="lrsEndpoint" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Auto Sync</label>
                        <select class="form-select" id="autoSync">
                            <option value="disabled">Disabled</option>
                            <option value="hourly">Hourly</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        {% bootstrap_button "Save Configuration" button_type="button" button_class="btn-primary" onclick="saveLrsConfig()" icon="save" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Moodle Services Section -->
    <div class="sync-section">
        <div class="d-flex align-items-center mb-4">
            <div class="flex-grow-1">
                <h4 class="mb-0">
                    <i class="bi bi-gear-wide me-2"></i>
                    Moodle Web Services
                </h4>
                <p class="text-muted mb-0">Manage Moodle web services and API functions</p>
            </div>
            <span class="instance-status status-online">Available</span>
        </div>
        
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Service Name</th>
                                <th>Short Name</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTableBody">
                            <!-- Services will be loaded here -->
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    <i class="bi bi-gear me-2"></i>
                                    Loading web services...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

    <!-- Add Moodle Instance Modal -->
    <div class="modal fade" id="addMoodleModal" tabindex="-1" aria-labelledby="addMoodleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMoodleModalLabel">Add Moodle Instance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addMoodleForm">
            <div class="modal-footer">
                {% bootstrap_button "Close" button_type="button" button_class="btn-secondary" data_bs_dismiss="modal" %}
                {% bootstrap_button "Download Report" button_type="button" button_class="btn-success" onclick="downloadReport()" icon="download" %}
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="alertContainer" class="alert-container"></div>

<script>
// Moodle Manager JavaScript
let moodleManager = {
    integrations: [],
    selectedIntegration: null,
    connectionStatus: null,
    testingConnection: false,
    moodleServices: [],
    moodleStats: null,
    
    async init() {
        await this.loadIntegrations();
    },
    
    async loadIntegrations() {
        try {
            const response = await fetch('/api/moodle-integrations/');
            if (response.ok) {
                const data = await response.json();
                this.integrations = Array.isArray(data) ? data : [];
                this.renderInstances();
            } else {
                this.showMessage('Failed to load Moodle integrations', 'error');
            }
        } catch (error) {
            console.error('Error loading integrations:', error);
            this.showMessage('Error loading Moodle integrations', 'error');
            this.integrations = [];
        }
    },
    
    renderInstances() {
        const container = document.getElementById('moodleInstances');
        const emptyState = document.getElementById('emptyState');
        
        if (this.integrations.length === 0) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            // Update stats
            document.getElementById('totalInstances').textContent = '0';
            document.getElementById('activeConnections').textContent = '0';
            return;
        }
        
        container.style.display = 'flex';
        emptyState.style.display = 'none';
        
        // Update stats
        document.getElementById('totalInstances').textContent = this.integrations.length;
        document.getElementById('activeConnections').textContent = this.integrations.filter(i => i.is_active).length;
        
        container.innerHTML = this.integrations.map(integration => `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="instance-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="mb-0">
                                <i class="bi bi-server me-2"></i>
                                ${integration.moodle_site_name}
                            </h6>
                            <span class="instance-status ${integration.is_active ? 'status-online' : 'status-offline'}">
                                ${integration.is_active ? 'Online' : 'Offline'}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex align-items-center text-muted small mb-2">
                                <i class="bi bi-globe me-2"></i>
                                <span class="text-truncate">${integration.moodle_url}</span>
                            </div>
                            <div class="d-flex align-items-center text-muted small">
                                <i class="bi bi-clock me-2"></i>
                                <span>${integration.last_sync ? 'Last sync: ' + new Date(integration.last_sync).toLocaleDateString() : 'Never synced'}</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-gradient flex-grow-1 action-btn" onclick="moodleManager.selectIntegration(${integration.id})">
                                <i class="bi bi-arrow-right me-2"></i>Select & Manage
                            </button>
                            <button class="btn btn-outline-secondary action-btn" onclick="moodleManager.editInstance(${integration.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger action-btn" onclick="moodleManager.deleteInstance(${integration.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    },
    
    selectIntegration(id) {
        this.selectedIntegration = id;
        const integration = this.integrations.find(i => i.id === id);
        if (integration) {
            // Update instance name
            const instanceNameElement = document.getElementById('selectedInstanceName');
            if (instanceNameElement) {
                instanceNameElement.textContent = integration.moodle_site_name;
            }
            
            // Update instance URL
            const instanceUrlElement = document.getElementById('selectedInstanceUrl');
            if (instanceUrlElement) {
                instanceUrlElement.value = integration.moodle_url;
            }
            
            // Show instance management section
            const instanceManagementElement = document.getElementById('instanceManagement');
            if (instanceManagementElement) {
                instanceManagementElement.style.display = 'block';
            }
            
            // Populate LRS endpoint
            const lrsEndpointElement = document.getElementById('lrsEndpoint');
            if (lrsEndpointElement) {
                lrsEndpointElement.value = integration.lrs_endpoint || '{{ lrs_endpoint }}';
            }
            
            // Set auto sync value
            const autoSyncElement = document.getElementById('autoSync');
            if (autoSyncElement) {
                autoSyncElement.value = integration.auto_sync || 'disabled';
            }
            
            this.loadMoodleData();
        }
    },
    
    async testConnection() {
        if (!this.selectedIntegration) return;
        
        const integration = this.integrations.find(i => i.id === this.selectedIntegration);
        if (!integration) return;
        
        const btn = document.getElementById('testConnectionBtn');
        const btnText = document.getElementById('testBtnText');
        
        this.testingConnection = true;
        btn.disabled = true;
        btnText.textContent = 'Testing...';
        
        try {
            const response = await fetch('/api/test-moodle-connection/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_url: integration.moodle_url,
                    token: integration.moodle_token
                })
            });
            
            const result = await response.json();
            this.showConnectionStatus(result);
            
        } catch (error) {
            console.error('Connection test error:', error);
            this.showConnectionStatus({
                connected: false,
                message: 'Connection test failed: ' + error.message
            });
        } finally {
            this.testingConnection = false;
            btn.disabled = false;
            btnText.textContent = 'Test Connection';
        }
    },
    
    showConnectionStatus(status) {
        const statusDiv = document.getElementById('connectionStatus');
        if (!statusDiv) {
            console.error('Connection status div not found');
            this.showMessage(status.message || 'Connection test completed', status.connected ? 'success' : 'error');
            return;
        }
        
        // Create alert element if it doesn't exist
        let alert = statusDiv.querySelector('.alert');
        if (!alert) {
            alert = document.createElement('div');
            alert.className = 'alert alert-dismissible fade show';
            statusDiv.appendChild(alert);
        }
        
        const icon = document.createElement('i');
        icon.className = 'fs-4 me-3';
        
        const title = document.createElement('h6');
        title.className = 'mb-1';
        
        const message = document.createElement('p');
        message.className = 'mb-0';
        
        // Clear existing content
        alert.innerHTML = '';
        
        if (status.connected) {
            alert.className = 'alert alert-success alert-dismissible fade show';
            icon.className = 'bi bi-check-circle-fill fs-4 text-success me-3';
            title.textContent = 'Connected to Moodle';
            message.textContent = status.message;
            
            if (status.site_info) {
                const siteInfo = document.createElement('div');
                siteInfo.className = 'mt-2';
                siteInfo.innerHTML = `
                    <hr>
                    <h6 class="text-muted mb-2">Site Information:</h6>
                    <div class="small">
                        <div><strong>Site Name:</strong> ${status.site_info.sitename || 'Unknown'}</div>
                        <div><strong>Site URL:</strong> ${status.site_info.siteurl || 'Unknown'}</div>
                        <div><strong>Moodle Version:</strong> ${status.site_info.release || 'Unknown'}</div>
                    </div>
                `;
                alert.appendChild(siteInfo);
            }
        } else {
            alert.className = 'alert alert-danger alert-dismissible fade show';
            icon.className = 'bi bi-x-circle-fill fs-4 text-danger me-3';
            title.textContent = 'Connection Failed';
            message.textContent = status.message;
            
            // Show debug information if available
            if (status.debug_info) {
                const debugInfo = document.createElement('div');
                debugInfo.className = 'mt-3';
                debugInfo.innerHTML = `
                    <hr>
                    <h6 class="text-muted mb-2">Debug Information:</h6>
                    <div class="small">
                        <div><strong>Moodle URL:</strong> ${status.debug_info.moodle_url || 'Not provided'}</div>
                        <div><strong>Web Service URL:</strong> ${status.debug_info.webservice_url || 'Unknown'}</div>
                        <div><strong>Token Provided:</strong> ${status.debug_info.token_provided ? 'Yes' : 'No'}</div>
                    </div>
                `;
                alert.appendChild(debugInfo);
            }
        }
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'btn-close';
        closeBtn.setAttribute('data-bs-dismiss', 'alert');
        alert.appendChild(closeBtn);
        
        // Assemble the alert
        const contentDiv = document.createElement('div');
        contentDiv.className = 'd-flex align-items-center';
        contentDiv.appendChild(icon);
        
        const textDiv = document.createElement('div');
        textDiv.appendChild(title);
        textDiv.appendChild(message);
        contentDiv.appendChild(textDiv);
        
        alert.insertBefore(contentDiv, alert.firstChild);
        
        statusDiv.style.display = 'block';
    },
    
    async loadMoodleData() {
        if (!this.selectedIntegration) return;
        
        const integration = this.integrations.find(i => i.id === this.selectedIntegration);
        if (!integration) return;
        
        try {
            const response = await fetch('/api/moodle-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_url: integration.moodle_url,
                    token: integration.moodle_token
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                this.moodleServices = data.services || [];
                this.moodleStats = data.stats || {
                    users_count: 0,
                    courses_count: 0,
                    services_count: 0
                };
                this.renderServices();
                this.renderStats();
            }
        } catch (error) {
            console.error('Error loading Moodle data:', error);
            this.moodleServices = [];
            this.moodleStats = {
                users_count: 0,
                courses_count: 0,
                services_count: 0
            };
        }
    },
    
    renderServices() {
        const tbody = document.getElementById('servicesTableBody');
        
        if (!tbody) {
            return; // Services section not available
        }
        
        if (this.moodleServices.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-3">
                        <i class="bi bi-gear me-2"></i>
                        No web services found. Create your first web service to get started.
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = this.moodleServices.map(service => `
                <tr>
                    <td>${service.name}</td>
                    <td><code class="bg-light px-2 py-1 rounded">${service.shortname}</code></td>
                    <td>
                        <span class="badge ${service.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${service.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="moodleManager.viewServiceDetails(${service.id})">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    },
    
    renderStats() {
        const usersCountElement = document.getElementById('usersCount');
        const coursesCountElement = document.getElementById('coursesCount');
        const servicesCountElement = document.getElementById('servicesCount');
        
        if (usersCountElement) {
            usersCountElement.textContent = this.moodleStats.users_count;
        }
        if (coursesCountElement) {
            coursesCountElement.textContent = this.moodleStats.courses_count;
        }
        if (servicesCountElement) {
            servicesCountElement.textContent = this.moodleStats.services_count;
        }
        
        // Also update the main statistics in hero section
        const totalStatementsElement = document.getElementById('totalStatements');
        if (totalStatementsElement) {
            totalStatementsElement.textContent = this.moodleStats.users_count + this.moodleStats.courses_count + this.moodleStats.services_count;
        }
    },
    async saveMoodleInstance() {
        const siteName = document.getElementById('moodleSiteName').value;
        const url = document.getElementById('moodleUrl').value;
        const token = document.getElementById('moodleToken').value;
        const webServiceUser = document.getElementById('webServiceUser').value;
        
        if (!siteName || !url) {
            this.showMessage('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/moodle-integrations/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_site_name: siteName,
                    moodle_url: url,
                    moodle_token: token,
                    web_service_user: webServiceUser,
                    is_active: true
                })
            });
            
            if (response.ok) {
                this.showMessage('Moodle instance added successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addMoodleModal')).hide();
                document.getElementById('addMoodleForm').reset();
                await this.loadIntegrations();
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to add Moodle instance', 'error');
            }
        } catch (error) {
            console.error('Error saving Moodle instance:', error);
            this.showMessage('Error saving Moodle instance', 'error');
        }
    },
    
    getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    },
    
    showMessage(text, type = 'success') {
        const container = document.getElementById('alertContainer');
        const alertId = 'alert-' + Date.now();
        
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', alertHtml);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 3000);
    },
    
    viewServiceDetails(serviceId) {
        const service = this.moodleServices.find(s => s.id === serviceId);
        if (service) {
            this.showMessage(`Service: ${service.name} (${service.shortname}) - ${service.enabled ? 'Enabled' : 'Disabled'}`, 'success');
        }
    },
    
    async updateMoodleInstance() {
        const id = document.getElementById('editInstanceId').value;
        const siteName = document.getElementById('editMoodleSiteName').value;
        const url = document.getElementById('editMoodleUrl').value;
        const token = document.getElementById('editMoodleToken').value;
        const webServiceUser = document.getElementById('editWebServiceUser').value;
        const isActive = document.getElementById('editIsActive').checked;
        
        if (!siteName || !url) {
            this.showMessage('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/moodle-integrations/${id}/update/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_site_name: siteName,
                    moodle_url: url,
                    moodle_token: token,
                    web_service_user: webServiceUser,
                    is_active: isActive
                })
            });
            
            if (response.ok) {
                this.showMessage('Moodle instance updated successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editMoodleModal')).hide();
                await this.loadIntegrations();
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to update Moodle instance', 'error');
            }
        } catch (error) {
            console.error('Error updating Moodle instance:', error);
            this.showMessage('Error updating Moodle instance', 'error');
        }
    },
    
    async deleteInstance(id) {
        if (!confirm('Are you sure you want to delete this Moodle instance? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/moodle-integrations/${id}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': this.getCsrfToken()
                }
            });
            
            if (response.ok) {
                this.showMessage('Moodle instance deleted successfully', 'success');
                await this.loadIntegrations();
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to delete Moodle instance', 'error');
            }
        } catch (error) {
            console.error('Error deleting Moodle instance:', error);
            this.showMessage('Error deleting Moodle instance', 'error');
        }
    },
    
    clearSelectedInstance() {
        this.selectedIntegration = null;
        document.getElementById('instanceManagement').style.display = 'none';
        this.connectionStatus = null;
    },
    
    copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            this.showMessage('Copied to clipboard', 'success');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            this.showMessage('Failed to copy to clipboard', 'error');
        });
    },
    
    async syncUsers() {
        if (!this.selectedIntegration) return;
        
        const integration = this.integrations.find(i => i.id === this.selectedIntegration);
        if (!integration) return;
        
        try {
            const response = await fetch('/api/sync-moodle-users/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_url: integration.moodle_url,
                    token: integration.moodle_token
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                this.showMessage(`Successfully synced ${result.synced_count} users`, 'success');
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to sync users', 'error');
            }
        } catch (error) {
            console.error('Error syncing users:', error);
            this.showMessage('Failed to sync users', 'error');
        }
    },
    
    async syncCourses() {
        if (!this.selectedIntegration) return;
        
        const integration = this.integrations.find(i => i.id === this.selectedIntegration);
        if (!integration) return;
        
        try {
            const response = await fetch('/api/sync-moodle-courses/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_url: integration.moodle_url,
                    token: integration.moodle_token
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                this.showMessage(`Successfully synced ${result.synced_count} courses`, 'success');
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to sync courses', 'error');
            }
        } catch (error) {
            console.error('Error syncing courses:', error);
            this.showMessage('Failed to sync courses', 'error');
        }
    },
    
    async syncActivities() {
        if (!this.selectedIntegration) return;
        
        const integration = this.integrations.find(i => i.id === this.selectedIntegration);
        if (!integration) return;
        
        try {
            const response = await fetch('/api/sync-moodle-activities/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_url: integration.moodle_url,
                    token: integration.moodle_token
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                this.showMessage(`Successfully synced ${result.synced_count} activities`, 'success');
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to sync activities', 'error');
            }
        } catch (error) {
            console.error('Error syncing activities:', error);
            this.showMessage('Failed to sync activities', 'error');
        }
    },
    
    async generateReports() {
        if (!this.selectedIntegration) return;
        
        const integration = this.integrations.find(i => i.id === this.selectedIntegration);
        if (!integration) return;
        
        try {
            // Find the button that was clicked
            const generateBtn = event && event.target ? event.target : document.querySelector('[onclick*="generateReports"]');
            const originalText = generateBtn ? generateBtn.innerHTML : '<i class="bi bi-file-earmark-text me-2"></i>Generate Reports';
            
            // Show loading state
            if (generateBtn) {
                generateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Generating...';
                generateBtn.disabled = true;
            }
            
            const response = await fetch('/api/generate-xapi-reports/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    moodle_url: integration.moodle_url,
                    token: integration.moodle_token
                })
            });
            
            // Restore button state
            if (generateBtn) {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
            
            if (response.ok) {
                const result = await response.json();
                
                // Store report data for download
                this.lastReportData = result;
                
                // Show download button
                const downloadBtn = document.getElementById('downloadReportBtn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'block';
                }
                
                // Show report modal with fallback
                try {
                    this.showReportModal(result);
                } catch (modalError) {
                    console.error('Modal error:', modalError);
                    // Fallback: show success message and direct download
                    this.showMessage(`Generated ${result.reports_count} xAPI reports. Download available.`, 'success');
                }
                
                this.showMessage(`Generated ${result.reports_count} xAPI reports`, 'success');
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to generate reports', 'error');
            }
        } catch (error) {
            console.error('Error generating reports:', error);
            
            // Restore button state
            const generateBtn = event && event.target ? event.target : document.querySelector('[onclick*="generateReports"]');
            if (generateBtn) {
                generateBtn.innerHTML = '<i class="bi bi-file-earmark-text me-2"></i>Generate Reports';
                generateBtn.disabled = false;
            }
            
            this.showMessage('Failed to generate reports', 'error');
        }
    },
    
    downloadReport() {
        if (this.lastReportData && this.lastReportData.download_url) {
            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = this.lastReportData.download_url;
            link.download = `xapi_report_${new Date().toISOString().slice(0,10)}.json`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            this.showMessage('Report downloaded successfully', 'success');
        } else {
            // Fallback to direct API call
            window.open('/api/download-xapi-report/', '_blank');
        }
    },
    
    showReportModal(reportData) {
        const modalElement = document.getElementById('reportModal');
        const contentElement = document.getElementById('reportContent');
        
        if (!modalElement || !contentElement) {
            console.error('Report modal elements not found');
            this.showMessage('Report data available. Use download button to get the report.', 'success');
            return;
        }
        
        // Format report data for display
        const reportHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-calendar-range me-2"></i>Report Period</h6>
                    <p class="text-muted">
                        <strong>Start:</strong> ${new Date(reportData.report_data.period.start).toLocaleString()}<br>
                        <strong>End:</strong> ${new Date(reportData.report_data.period.end).toLocaleString()}<br>
                        <strong>Duration:</strong> ${reportData.report_data.period.days} days
                    </p>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-bar-chart me-2"></i>Summary</h6>
                    <p class="text-muted">
                        <strong>Total Statements:</strong> ${reportData.report_data.summary.total_statements}<br>
                        <strong>Unique Actors:</strong> ${reportData.report_data.summary.unique_actors}<br>
                        <strong>Unique Activities:</strong> ${reportData.report_data.summary.unique_activities}<br>
                        <strong>Unique Verbs:</strong> ${reportData.report_data.summary.unique_verbs}
                    </p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="bi bi-list-ul me-2"></i>Recent Statements</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Actor</th>
                                    <th>Verb</th>
                                    <th>Activity</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.report_data.statements.slice(0, 5).map(stmt => `
                                    <tr>
                                        <td>${new Date(stmt.timestamp).toLocaleString()}</td>
                                        <td>${stmt.actor.name}</td>
                                        <td>${stmt.verb.display ? stmt.verb.display['en-US'] || stmt.verb.id : stmt.verb.id}</td>
                                        <td>${stmt.activity.definition ? stmt.activity.definition.name ? stmt.activity.definition.name['en-US'] || stmt.activity.definition.name : stmt.activity.id : stmt.activity.id}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${reportData.report_data.statements.length > 5 ? 
                            `<p class="text-muted small mt-2">Showing 5 of ${reportData.report_data.statements.length} statements</p>` : 
                            `<p class="text-muted small mt-2">No statements found</p>`
                        }
                    </div>
                </div>
            </div>
        `;
        
        contentElement.innerHTML = reportHtml;
        
        // Remove aria-hidden before showing to prevent accessibility issues
        modalElement.removeAttribute('aria-hidden');
        
        // Try to show modal with proper accessibility handling
        try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                // Use Bootstrap's modal for proper accessibility
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
                // Ensure Bootstrap doesn't add aria-hidden back
                setTimeout(() => {
                    if (modalElement.style.display !== 'none') {
                        modalElement.removeAttribute('aria-hidden');
                    }
                }, 100);
            } else {
                // Fallback: show modal manually with proper accessibility
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                document.body.classList.add('modal-open');
                
                // Ensure no aria-hidden when modal is visible
                modalElement.removeAttribute('aria-hidden');
                
                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.id = 'modal-backdrop';
                document.body.appendChild(backdrop);
                
                // Add close handlers with proper cleanup
                const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"]');
                closeButtons.forEach(btn => {
                    btn.onclick = () => {
                        this.closeModal(modalElement);
                    };
                });
                
                // Close on backdrop click
                backdrop.onclick = () => {
                    this.closeModal(modalElement);
                };
                
                // Close on Escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal(modalElement);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }
        } catch (error) {
            console.error('Modal initialization error:', error);
            // Fallback: show success message
            this.showMessage('Report generated successfully. Use download button to get the report.', 'success');
        }
    },
    
    closeModal(modalElement) {
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        document.body.classList.remove('modal-open');
        
        // Add aria-hidden back only when modal is completely hidden
        modalElement.setAttribute('aria-hidden', 'true');
        
        const backdropElement = document.getElementById('modal-backdrop');
        if (backdropElement) {
            backdropElement.remove();
        }
    },
    
    async saveLrsConfig() {
        if (!this.selectedIntegration) return;
        
        const integration = this.integrations.find(i => i.id === this.selectedIntegration);
        if (!integration) return;
        
        const lrsEndpoint = document.getElementById('lrsEndpoint').value;
        const autoSync = document.getElementById('autoSync').value;
        
        try {
            const response = await fetch(`/api/moodle-integrations/${integration.id}/update/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    lrs_endpoint: lrsEndpoint,
                    auto_sync: autoSync,
                    moodle_site_name: integration.moodle_site_name,
                    moodle_url: integration.moodle_url,
                    moodle_token: integration.moodle_token,
                    is_active: integration.is_active
                })
            });
            
            if (response.ok) {
                this.showMessage('LRS configuration saved successfully', 'success');
            } else {
                const errorData = await response.json();
                this.showMessage(errorData.error || 'Failed to save LRS configuration', 'error');
            }
        } catch (error) {
            console.error('Error saving LRS config:', error);
            this.showMessage('Failed to save LRS configuration', 'error');
        }
    }
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize popovers
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Initialize the manager
    moodleManager.init();
});

// Global functions for onclick handlers
function clearSelectedInstance() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.clearSelectedInstance();
    }
}

function testConnection() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.testConnection();
    }
}

function saveMoodleInstance() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.saveMoodleInstance();
    }
}

function updateMoodleInstance() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.updateMoodleInstance();
    }
}

function copyToClipboard(text) {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.copyToClipboard(text);
    } else {
        navigator.clipboard.writeText(text).then(() => {
            // Fallback message if moodleManager is not available
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
            alert.role = 'alert';
            alert.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>Copied to clipboard
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alert);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 3000);
        });
    }
}

function syncUsers() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.syncUsers();
    }
}

function syncCourses() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.syncCourses();
    }
}

function syncActivities() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.syncActivities();
    }
}

function generateReports() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.generateReports();
    }
}

function downloadReport() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.downloadReport();
    }
}

function saveLrsConfig() {
    if (typeof moodleManager !== 'undefined') {
        moodleManager.saveLrsConfig();
    }
}
</script>
{% endblock %}
