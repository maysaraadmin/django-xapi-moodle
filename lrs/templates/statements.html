{% extends 'base.html' %}

{% block title %}Statements - xAPI LRS{% endblock %}

{% block content %}
<div x-data="statementsPage()" x-init="init()">
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">xAPI Statements</h2>
            <p class="mt-1 text-sm text-gray-600">View and filter learning statements</p>
        </div>
        <button @click="showFilters = !showFilters" class="bg-white px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
            <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"></path>
            </svg>
            Filters
        </button>
    </div>

    <!-- Filters -->
    <div x-show="showFilters" x-cloak class="bg-white shadow rounded-lg mb-6 p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Filter Statements</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Actor</label>
                <input type="text" x-model="filters.actor" @input="applyFilters" placeholder="Actor name or ID" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Verb</label>
                <input type="text" x-model="filters.verb" @input="applyFilters" placeholder="Verb ID" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Activity</label>
                <input type="text" x-model="filters.activity" @input="applyFilters" placeholder="Activity ID" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Since</label>
                <input type="datetime-local" x-model="filters.since" @input="applyFilters" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>
        <div class="mt-4 flex justify-end space-x-3">
            <button @click="clearFilters" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
                Clear Filters
            </button>
        </div>
    </div>

    <!-- Statements List -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">All Statements</h3>
                <span class="text-sm text-gray-500">
                    <span x-text="totalCount">0</span> total statements
                </span>
            </div>
            
            <!-- Loading -->
            <div x-show="loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Loading statements...</p>
            </div>

            <!-- Statements -->
            <div x-show="!loading" class="space-y-4">
                <template x-for="statement in statements" :key="statement.statement_id">
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <span x-text="statement.actor_data?.name || 'Unknown Actor'"></span>
                                    </span>
                                    <span class="text-gray-500">â†’</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" x-text="statement.verb_data?.verb_id?.split('/').pop() || 'Unknown Verb'"></span>
                                </div>
                                <p class="text-sm text-gray-900 font-medium" x-text="statement.activity_data?.definition?.name?.['en-US'] || statement.activity_data?.activity_id || 'Unknown Activity'"></p>
                                <p class="text-xs text-gray-500 mt-1" x-text="statement.activity_data?.activity_id"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500" x-text="formatDate(statement.timestamp)"></p>
                                <button @click="toggleDetails(statement.statement_id)" class="text-xs text-blue-600 hover:text-blue-800 mt-1">
                                    <span x-text="expandedStatements.includes(statement.statement_id) ? 'Hide' : 'Show'"></span> Details
                                </button>
                            </div>
                        </div>
                        
                        <!-- Expanded Details -->
                        <div x-show="expandedStatements.includes(statement.statement_id)" x-cloak class="mt-4 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <h4 class="font-medium text-gray-900 mb-2">Actor</h4>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <p><strong>Name:</strong> <span x-text="statement.actor_data?.name"></span></p>
                                        <p><strong>Type:</strong> <span x-text="statement.actor_data?.actor_type"></span></p>
                                        <p><strong>Email:</strong> <span x-text="statement.actor_data?.mbox"></span></p>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900 mb-2">Verb</h4>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <p><strong>ID:</strong> <span x-text="statement.verb_data?.verb_id"></span></p>
                                        <p><strong>Display:</strong> <span x-text="JSON.stringify(statement.verb_data?.display)"></span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Result (if exists) -->
                            <div x-show="statement.result" class="mt-4">
                                <h4 class="font-medium text-gray-900 mb-2">Result</h4>
                                <div class="bg-gray-50 p-3 rounded">
                                    <pre class="text-xs overflow-x-auto" x-text="JSON.stringify(statement.result, null, 2)"></pre>
                                </div>
                            </div>
                            
                            <!-- Full Statement JSON -->
                            <div class="mt-4">
                                <h4 class="font-medium text-gray-900 mb-2">Full Statement</h4>
                                <div class="bg-gray-50 p-3 rounded">
                                    <pre class="text-xs overflow-x-auto" x-text="JSON.stringify(statement, null, 2)"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- No Statements -->
                <div x-show="statements.length === 0 && !loading" class="text-center py-8 text-gray-500">
                    <i class="bi bi-file-text mx-auto fs-1 text-gray-400"></i>
                    <p class="mt-2">No statements found</p>
                    <p class="text-sm">Start by creating some xAPI statements or adjust your filters.</p>
                </div>
            </div>

            <!-- Pagination -->
            <div x-show="!loading && statements.length > 0" class="mt-6 flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    Showing <span x-text="(currentPage - 1) * pageSize + 1"></span> to 
                    <span x-text="Math.min(currentPage * pageSize, totalCount)"></span> of 
                    <span x-text="totalCount"></span> results
                </div>
                <div class="flex space-x-2">
                    <button @click="previousPage" :disabled="!previousUrl" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                        Previous
                    </button>
                    <span class="px-3 py-1 text-sm" x-text="`Page ${currentPage}`"></span>
                    <button @click="nextPage" :disabled="!nextUrl" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function statementsPage() {
    return {
        statements: [],
        loading: true,
        showFilters: false,
        expandedStatements: [],
        totalCount: 0,
        currentPage: 1,
        pageSize: 20,
        previousUrl: null,
        nextUrl: null,
        filters: {
            actor: '',
            verb: '',
            activity: '',
            since: ''
        },
        
        async init() {
            await this.loadStatements();
        },
        
        async loadStatements() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                params.append('page_size', this.pageSize);
                
                if (this.filters.actor) params.append('actor', this.filters.actor);
                if (this.filters.verb) params.append('verb', this.filters.verb);
                if (this.filters.activity) params.append('activity', this.filters.activity);
                if (this.filters.since) params.append('since', this.filters.since);
                
                const response = await fetch(`/api/statements/get?${params}`);
                const data = await response.json();
                
                this.statements = data.results || [];
                this.totalCount = data.count || 0;
                this.previousUrl = data.previous;
                this.nextUrl = data.next;
                
                // Calculate current page from results
                if (this.nextUrl) {
                    const nextPage = new URL(this.nextUrl, window.location.origin).searchParams.get('page');
                    this.currentPage = parseInt(nextPage) - 1;
                } else if (this.previousUrl) {
                    const prevPage = new URL(this.previousUrl, window.location.origin).searchParams.get('page');
                    this.currentPage = parseInt(prevPage) + 1;
                } else {
                    this.currentPage = 1;
                }
            } catch (error) {
                console.error('Error loading statements:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async applyFilters() {
            await this.loadStatements();
        },
        
        async clearFilters() {
            this.filters = {
                actor: '',
                verb: '',
                activity: '',
                since: ''
            };
            await this.loadStatements();
        },
        
        async nextPage() {
            if (this.nextUrl) {
                this.loading = true;
                try {
                    const response = await fetch(this.nextUrl);
                    const data = await response.json();
                    
                    this.statements = data.results || [];
                    this.previousUrl = data.previous;
                    this.nextUrl = data.next;
                    this.currentPage++;
                } catch (error) {
                    console.error('Error loading next page:', error);
                } finally {
                    this.loading = false;
                }
            }
        },
        
        async previousPage() {
            if (this.previousUrl) {
                this.loading = true;
                try {
                    const response = await fetch(this.previousUrl);
                    const data = await response.json();
                    
                    this.statements = data.results || [];
                    this.previousUrl = data.previous;
                    this.nextUrl = data.next;
                    this.currentPage--;
                } catch (error) {
                    console.error('Error loading previous page:', error);
                } finally {
                    this.loading = false;
                }
            }
        },
        
        toggleDetails(statementId) {
            const index = this.expandedStatements.indexOf(statementId);
            if (index > -1) {
                this.expandedStatements.splice(index, 1);
            } else {
                this.expandedStatements.push(statementId);
            }
        },
        
        formatDate(timestamp) {
            return new Date(timestamp).toLocaleString();
        }
    }
}
</script>
{% endblock %}
