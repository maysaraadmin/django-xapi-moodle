{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Statements - xAPI LRS{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h2 mb-2">xAPI Statements</h2>
                    <p class="text-muted">View and filter learning statements</p>
                </div>
                <button class="btn btn-outline-primary" onclick="toggleFilters()">
                    <i class="bi bi-funnel me-2"></i>Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div id="filtersSection" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-body">
            <h5 class="card-title mb-4">Filter Statements</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Actor</label>
                    <input type="text" id="actorFilter" placeholder="Actor name or ID" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Verb</label>
                    <input type="text" id="verbFilter" placeholder="Verb ID" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Activity</label>
                    <input type="text" id="activityFilter" placeholder="Activity ID" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Since</label>
                    <input type="datetime-local" id="sinceFilter" class="form-control">
                </div>
            </div>
            <div class="mt-3 text-end">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                <button class="btn btn-primary ms-2" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Statements List -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">All Statements</h5>
                <span class="text-muted">
                    <span id="totalCount">0</span> total statements
                </span>
            </div>
            
            <!-- Loading -->
            <div id="loadingSection" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading statements...</p>
            </div>

            <!-- Statements -->
            <div id="statementsList">
                <!-- Statements will be loaded here -->
            </div>
            
            <!-- No Statements -->
            <div id="noStatements" class="text-center py-5 text-muted" style="display: none;">
                <i class="bi bi-file-text fs-1 text-muted d-block mb-3"></i>
                <p class="mb-2">No statements found</p>
                <p class="small">Start by creating some xAPI statements or adjust your filters.</p>
            </div>

            <!-- Pagination -->
            <div id="paginationSection" class="mt-4 d-flex justify-content-between align-items-center" style="display: none;">
                <div class="text-muted">
                    Showing <span id="showingStart">0</span> to 
                    <span id="showingEnd">0</span> of 
                    <span id="totalCount2">0</span> results
                </div>
                <div>
                    <button id="prevBtn" class="btn btn-outline-secondary me-2" onclick="previousPage()" disabled>
                        Previous
                    </button>
                    <span class="px-3 py-1" id="currentPage">Page 1</span>
                    <button id="nextBtn" class="btn btn-outline-secondary ms-2" onclick="nextPage()" disabled>
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Statements Page JavaScript
let statementsData = {
    statements: [],
    loading: false,
    showFilters: false,
    expandedStatements: [],
    totalCount: 0,
    currentPage: 1,
    pageSize: 20,
    previousUrl: null,
    nextUrl: null,
    filters: {
        actor: '',
        verb: '',
        activity: '',
        since: ''
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStatements();
});

// Toggle filters visibility
function toggleFilters() {
    const filtersSection = document.getElementById('filtersSection');
    if (filtersSection.style.display === 'none') {
        filtersSection.style.display = 'block';
    } else {
        filtersSection.style.display = 'none';
    }
}

// Apply filters
function applyFilters() {
    statementsData.filters.actor = document.getElementById('actorFilter').value;
    statementsData.filters.verb = document.getElementById('verbFilter').value;
    statementsData.filters.activity = document.getElementById('activityFilter').value;
    statementsData.filters.since = document.getElementById('sinceFilter').value;
    loadStatements();
}

// Clear filters
function clearFilters() {
    document.getElementById('actorFilter').value = '';
    document.getElementById('verbFilter').value = '';
    document.getElementById('activityFilter').value = '';
    document.getElementById('sinceFilter').value = '';
    statementsData.filters = {
        actor: '',
        verb: '',
        activity: '',
        since: ''
    };
    loadStatements();
}

// Load statements from API
async function loadStatements() {
    statementsData.loading = true;
    updateUI();
    
    try {
        const params = new URLSearchParams();
        params.append('page_size', statementsData.pageSize);
        
        if (statementsData.filters.actor) params.append('actor', statementsData.filters.actor);
        if (statementsData.filters.verb) params.append('verb', statementsData.filters.verb);
        if (statementsData.filters.activity) params.append('activity', statementsData.filters.activity);
        if (statementsData.filters.since) params.append('since', statementsData.filters.since);
        
        const response = await fetch(`/api/statements/get?${params}`);
        const data = await response.json();
        
        statementsData.statements = data.results || [];
        statementsData.totalCount = data.count || 0;
        statementsData.previousUrl = data.previous;
        statementsData.nextUrl = data.next;
        
        // Calculate current page
        if (statementsData.nextUrl) {
            const nextPage = new URL(statementsData.nextUrl, window.location.origin).searchParams.get('page');
            statementsData.currentPage = parseInt(nextPage) - 1;
        } else if (statementsData.previousUrl) {
            const prevPage = new URL(statementsData.previousUrl, window.location.origin).searchParams.get('page');
            statementsData.currentPage = parseInt(prevPage) + 1;
        } else {
            statementsData.currentPage = 1;
        }
    } catch (error) {
        console.error('Error loading statements:', error);
    } finally {
        statementsData.loading = false;
        updateUI();
    }
}

// Update UI based on current state
function updateUI() {
    const loadingSection = document.getElementById('loadingSection');
    const statementsList = document.getElementById('statementsList');
    const noStatements = document.getElementById('noStatements');
    const paginationSection = document.getElementById('paginationSection');
    const totalCount = document.getElementById('totalCount');
    const totalCount2 = document.getElementById('totalCount2');
    
    // Update total count
    totalCount.textContent = statementsData.totalCount;
    totalCount2.textContent = statementsData.totalCount;
    
    if (statementsData.loading) {
        loadingSection.style.display = 'block';
        statementsList.style.display = 'none';
        noStatements.style.display = 'none';
        paginationSection.style.display = 'none';
    } else if (statementsData.statements.length === 0) {
        loadingSection.style.display = 'none';
        statementsList.style.display = 'none';
        noStatements.style.display = 'block';
        paginationSection.style.display = 'none';
    } else {
        loadingSection.style.display = 'none';
        statementsList.style.display = 'block';
        noStatements.style.display = 'none';
        paginationSection.style.display = 'flex';
        renderStatements();
        updatePagination();
    }
}

// Render statements
function renderStatements() {
    const statementsList = document.getElementById('statementsList');
    
    const statementsHtml = statementsData.statements.map(statement => {
        const isExpanded = statementsData.expandedStatements.includes(statement.statement_id);
        const actorName = statement.actor_data?.name || 'Unknown Actor';
        const verb = statement.verb_data?.verb_id?.split('/').pop() || 'Unknown Verb';
        const activityName = statement.activity_data?.definition?.name?.['en-US'] || statement.activity_data?.activity_id || 'Unknown Activity';
        const activityId = statement.activity_data?.activity_id || '';
        const timestamp = formatDate(statement.timestamp);
        
        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="badge bg-primary">${actorName}</span>
                                <span class="text-muted">â†’</span>
                                <span class="badge bg-success">${verb}</span>
                            </div>
                            <h6 class="mb-1">${activityName}</h6>
                            <small class="text-muted d-block">${activityId}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">${timestamp}</small>
                            <button class="btn btn-sm btn-link p-0" onclick="toggleDetails('${statement.statement_id}')">
                                ${isExpanded ? 'Hide' : 'Show'} Details
                            </button>
                        </div>
                    </div>
                    
                    <!-- Expanded Details -->
                    <div id="details-${statement.statement_id}" class="${isExpanded ? '' : 'd-none'}">
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-semibold mb-2">Actor</h6>
                                <div class="bg-light p-3 rounded">
                                    <p class="mb-1"><strong>Name:</strong> ${statement.actor_data?.name || 'N/A'}</p>
                                    <p class="mb-1"><strong>Type:</strong> ${statement.actor_data?.actor_type || 'N/A'}</p>
                                    <p class="mb-0"><strong>Email:</strong> ${statement.actor_data?.mbox || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-semibold mb-2">Verb</h6>
                                <div class="bg-light p-3 rounded">
                                    <p class="mb-1"><strong>ID:</strong> ${statement.verb_data?.verb_id || 'N/A'}</p>
                                    <p class="mb-0"><strong>Display:</strong> ${JSON.stringify(statement.verb_data?.display) || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        ${statement.result ? `
                            <div class="mt-3">
                                <h6 class="fw-semibold mb-2">Result</h6>
                                <div class="bg-light p-3 rounded">
                                    <pre class="small mb-0">${JSON.stringify(statement.result, null, 2)}</pre>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="mt-3">
                            <h6 class="fw-semibold mb-2">Full Statement</h6>
                            <div class="bg-light p-3 rounded">
                                <pre class="small mb-0">${JSON.stringify(statement, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    statementsList.innerHTML = statementsHtml;
}

// Toggle statement details
function toggleDetails(statementId) {
    const index = statementsData.expandedStatements.indexOf(statementId);
    const detailsElement = document.getElementById(`details-${statementId}`);
    
    if (index > -1) {
        statementsData.expandedStatements.splice(index, 1);
        detailsElement.classList.add('d-none');
    } else {
        statementsData.expandedStatements.push(statementId);
        detailsElement.classList.remove('d-none');
    }
}

// Update pagination
function updatePagination() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const currentPage = document.getElementById('currentPage');
    const showingStart = document.getElementById('showingStart');
    const showingEnd = document.getElementById('showingEnd');
    
    const start = (statementsData.currentPage - 1) * statementsData.pageSize + 1;
    const end = Math.min(statementsData.currentPage * statementsData.pageSize, statementsData.totalCount);
    
    currentPage.textContent = `Page ${statementsData.currentPage}`;
    showingStart.textContent = start;
    showingEnd.textContent = end;
    
    prevBtn.disabled = !statementsData.previousUrl;
    nextBtn.disabled = !statementsData.nextUrl;
}

// Navigation functions
async function nextPage() {
    if (statementsData.nextUrl) {
        statementsData.loading = true;
        updateUI();
        
        try {
            const response = await fetch(statementsData.nextUrl);
            const data = await response.json();
            
            statementsData.statements = data.results || [];
            statementsData.previousUrl = data.previous;
            statementsData.nextUrl = data.next;
            statementsData.currentPage++;
        } catch (error) {
            console.error('Error loading next page:', error);
        } finally {
            statementsData.loading = false;
            updateUI();
        }
    }
}

async function previousPage() {
    if (statementsData.previousUrl) {
        statementsData.loading = true;
        updateUI();
        
        try {
            const response = await fetch(statementsData.previousUrl);
            const data = await response.json();
            
            statementsData.statements = data.results || [];
            statementsData.previousUrl = data.previous;
            statementsData.nextUrl = data.next;
            statementsData.currentPage--;
        } catch (error) {
            console.error('Error loading previous page:', error);
        } finally {
            statementsData.loading = false;
            updateUI();
        }
    }
}

// Format date
function formatDate(timestamp) {
    return new Date(timestamp).toLocaleString();
}
</script>
{% endblock %}
