{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Test API - xAPI LRS{% endblock %}

{% block content %}
<div x-data="testApi()" x-init="init()">
    <!-- Header -->
    <div class="mb-4">
        <h2 class="h2">API Testing</h2>
        <p class="text-muted">Test xAPI and Moodle API endpoints</p>
    </div>

    <div class="row">
        <!-- xAPI Statement Test -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="h5 mb-0">Create xAPI Statement</h3>
                </div>
                <div class="card-body">
                
                <div class="space-y-4">
                    <div class="mb-3">
                        <label class="form-label">Actor Name</label>
                        <input type="text" x-model="xapiTest.actor.name" placeholder="John Doe" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Actor Email</label>
                        <input type="email" x-model="xapiTest.actor.mbox" placeholder="john@example.com" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Verb</label>
                        <select x-model="xapiTest.verb" class="form-select">
                            <option value="http://adlnet.gov/expapi/verbs/completed">completed</option>
                            <option value="http://adlnet.gov/expapi/verbs/experienced">experienced</option>
                            <option value="http://adlnet.gov/expapi/verbs/attempted">attempted</option>
                            <option value="http://adlnet.gov/expapi/verbs/passed">passed</option>
                            <option value="http://adlnet.gov/expapi/verbs/failed">failed</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Activity Name</label>
                        <input type="text" x-model="xapiTest.activity.name" placeholder="Course Introduction" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Activity ID</label>
                        <input type="text" x-model="xapiTest.activity.id" placeholder="http://example.com/activity/1" class="form-control">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" x-model="xapiTest.includeResult" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label class="ml-2 text-sm text-gray-700">Include Result (Score)</label>
                    </div>
                    
                    <div x-show="xapiTest.includeResult" class="space-y-2">
                        <input type="number" x-model="xapiTest.result.score" placeholder="85" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="number" x-model="xapiTest.result.max" placeholder="100" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mt-4">
                        <button @click="sendXapiStatement" :disabled="xapiTest.loading" class="btn btn-primary w-100">
                            <span x-show="!xapiTest.loading"><i class="bi bi-send me-1"></i>Send xAPI Statement</span>
                            <span x-show="xapiTest.loading"><span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Sending...</span>
                        </button>
                    </div>
                    
                    <!-- xAPI Response -->
                    <div x-show="xapiTest.response" class="mt-4">
                        <h5 class="fw-semibold mb-2">Response:</h5>
                        <pre class="bg-light p-3 rounded small" x-text="JSON.stringify(xapiTest.response, null, 2)"></pre>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- Moodle Event Test -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h3 class="h5 mb-0">Send Moodle Event</h3>
                </div>
                <div class="card-body">
                
                <div class="space-y-4">
                    <div class="mb-3">
                        <label class="form-label">Event Type</label>
                        <select x-model="moodleTest.event_type" class="form-select">
                            <option value="course_viewed">course_viewed</option>
                            <option value="course_completed">course_completed</option>
                            <option value="user_loggedin">user_loggedin</option>
                            <option value="user_loggedout">user_loggedout</option>
                            <option value="quiz_attempt_submitted">quiz_attempt_submitted</option>
                            <option value="assignment_submitted">assignment_submitted</option>
                            <option value="forum_post_created">forum_post_created</option>
                            <option value="scorm_completed">scorm_completed</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">User ID</label>
                        <input type="text" x-model="moodleTest.user_id" placeholder="2" class="form-control">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">User Name</label>
                        <input type="text" x-model="moodleTest.user_name" placeholder="John Doe" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Course ID</label>
                        <input type="text" x-model="moodleTest.course_id" placeholder="3" class="form-control">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                        <input type="text" x-model="moodleTest.course_name" placeholder="Introduction to Psychology" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Activity ID</label>
                        <input type="text" x-model="moodleTest.activity_id" placeholder="1" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Activity Type</label>
                        <select x-model="moodleTest.activity_type" class="form-select">
                            <option value="quiz">quiz</option>
                            <option value="assignment">assignment</option>
                            <option value="forum">forum</option>
                            <option value="scorm">scorm</option>
                            <option value="page">page</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Activity Name</label>
                        <input type="text" x-model="moodleTest.activity_name" placeholder="Quiz 1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" x-model="moodleTest.includeGrade" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label class="ml-2 text-sm text-gray-700">Include Grade</label>
                    </div>
                    
                    <div x-show="moodleTest.includeGrade" class="space-y-2">
                        <input type="number" x-model="moodleTest.grade" placeholder="85" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="number" x-model="moodleTest.max_grade" placeholder="100" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mt-4">
                        <button @click="sendMoodleEvent" :disabled="moodleTest.loading" class="btn btn-success w-100">
                            <span x-show="!moodleTest.loading"><i class="bi bi-send me-1"></i>Send Moodle Event</span>
                            <span x-show="moodleTest.loading"><span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Sending...</span>
                        </button>
                    </div>
                    
                    <!-- Moodle Response -->
                    <div x-show="moodleTest.response" class="mt-4">
                        <h5 class="fw-semibold mb-2">Response:</h5>
                        <pre class="bg-light p-3 rounded small" x-text="JSON.stringify(moodleTest.response, null, 2)"></pre>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Quick Test Templates -->
    <div class="mt-8 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Quick Test Templates</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button @click="useTemplate('course_completion')" class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-left">
                    <h4 class="font-medium text-gray-900">Course Completion</h4>
                    <p class="text-sm text-gray-600 mt-1">Test a completed course event</p>
                </button>
                <button @click="useTemplate('quiz_attempt')" class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-left">
                    <h4 class="font-medium text-gray-900">Quiz Attempt</h4>
                    <p class="text-sm text-gray-600 mt-1">Test a quiz submission with score</p>
                </button>
                <button @click="useTemplate('forum_post')" class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-left">
                    <h4 class="font-medium text-gray-900">Forum Post</h4>
                    <p class="text-sm text-gray-600 mt-1">Test a forum discussion post</p>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function testApi() {
    return {
        xapiTest: {
            loading: false,
            response: null,
            actor: {
                name: 'Test User',
                mbox: 'test@example.com'
            },
            verb: 'http://adlnet.gov/expapi/verbs/completed',
            activity: {
                name: 'Test Activity',
                id: 'http://example.com/activity/1'
            },
            includeResult: false,
            result: {
                score: 85,
                max: 100
            }
        },
        moodleTest: {
            loading: false,
            response: null,
            event_type: 'course_completed',
            user_id: 123,
            user_name: 'Test User',
            course_id: 1,
            course_name: 'Test Course',
            activity_id: 1,
            activity_type: 'quiz',
            activity_name: 'Test Quiz',
            includeGrade: false,
            grade: 85,
            max_grade: 100
        },
        
        init() {
            // Initialize with default values
        },
        
        async sendXapiStatement() {
            this.xapiTest.loading = true;
            this.xapiTest.response = null;
            
            try {
                const statement = {
                    actor: {
                        objectType: 'Agent',
                        name: this.xapiTest.actor.name,
                        mbox: this.xapiTest.actor.mbox
                    },
                    verb: {
                        id: this.xapiTest.verb,
                        display: {'en-US': this.xapiTest.verb.split('/').pop()}
                    },
                    object: {
                        objectType: 'Activity',
                        id: this.xapiTest.activity.id,
                        definition: {
                            name: {'en-US': this.xapiTest.activity.name}
                        }
                    }
                };
                
                if (this.xapiTest.includeResult) {
                    statement.result = {
                        score: {
                            raw: this.xapiTest.result.score,
                            max: this.xapiTest.result.max,
                            scaled: this.xapiTest.result.score / this.xapiTest.result.max
                        },
                        completion: true,
                        success: this.xapiTest.result.score >= (this.xapiTest.result.max * 0.7)
                    };
                }
                
                const response = await fetch('/api/xapi/statements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(statement)
                });
                
                this.xapiTest.response = await response.json();
            } catch (error) {
                this.xapiTest.response = { error: error.message };
            } finally {
                this.xapiTest.loading = false;
            }
        },
        
        async sendMoodleEvent() {
            this.moodleTest.loading = true;
            this.moodleTest.response = null;
            
            try {
                const event = {
                    event_type: this.moodleTest.event_type,
                    user_id: this.moodleTest.user_id,
                    user_name: this.moodleTest.user_name,
                    course_id: this.moodleTest.course_id,
                    course_name: this.moodleTest.course_name,
                    activity_id: this.moodleTest.activity_id,
                    activity_type: this.moodleTest.activity_type,
                    activity_name: this.moodleTest.activity_name,
                    site_url: 'http://moodle.local'
                };
                
                if (this.moodleTest.includeGrade) {
                    event.grade = this.moodleTest.grade;
                    event.max_grade = this.moodleTest.max_grade;
                }
                
                const response = await fetch('/api/moodle/event/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(event)
                });
                
                this.moodleTest.response = await response.json();
            } catch (error) {
                this.moodleTest.response = { error: error.message };
            } finally {
                this.moodleTest.loading = false;
            }
        },
        
        useTemplate(template) {
            if (template === 'course_completion') {
                this.moodleTest = {
                    ...this.moodleTest,
                    event_type: 'course_completed',
                    user_id: 123,
                    user_name: 'John Student',
                    course_id: 1,
                    course_name: 'Introduction to Psychology',
                    activity_id: 1,
                    activity_type: 'course',
                    activity_name: 'Course Completion',
                    includeGrade: false
                };
            } else if (template === 'quiz_attempt') {
                this.moodleTest = {
                    ...this.moodleTest,
                    event_type: 'quiz_attempt_submitted',
                    user_id: 456,
                    user_name: 'Jane Smith',
                    course_id: 1,
                    course_name: 'Mathematics 101',
                    activity_id: 2,
                    activity_type: 'quiz',
                    activity_name: 'Midterm Quiz',
                    includeGrade: true,
                    grade: 92,
                    max_grade: 100
                };
            } else if (template === 'forum_post') {
                this.moodleTest = {
                    ...this.moodleTest,
                    event_type: 'forum_post_created',
                    user_id: 789,
                    user_name: 'Bob Johnson',
                    course_id: 2,
                    course_name: 'English Literature',
                    activity_id: 3,
                    activity_type: 'forum',
                    activity_name: 'Weekly Discussion',
                    includeGrade: false
                };
            }
        }
    }
}
</script>
{% endblock %}
