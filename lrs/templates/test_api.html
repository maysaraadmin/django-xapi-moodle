{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Test API - xAPI LRS{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="h2 mb-2">API Testing</h2>
            <p class="text-muted">Test xAPI and Moodle API endpoints</p>
        </div>
    </div>

    <div class="row">
        <!-- xAPI Statement Test -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Create xAPI Statement</h5>
                </div>
                <div class="card-body">
                    <form id="xapiForm">
                        <div class="mb-3">
                            <label class="form-label">Actor Name</label>
                            <input type="text" id="actorName" placeholder="John Doe" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Actor Email</label>
                            <input type="email" id="actorEmail" placeholder="john@example.com" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Verb</label>
                            <select id="verbSelect" class="form-select">
                                <option value="http://adlnet.gov/expapi/verbs/completed">completed</option>
                                <option value="http://adlnet.gov/expapi/verbs/experienced">experienced</option>
                                <option value="http://adlnet.gov/expapi/verbs/attempted">attempted</option>
                                <option value="http://adlnet.gov/expapi/verbs/passed">passed</option>
                                <option value="http://adlnet.gov/expapi/verbs/failed">failed</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Activity Name</label>
                            <input type="text" id="activityName" placeholder="Course Introduction" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Activity ID</label>
                            <input type="text" id="activityId" placeholder="http://example.com/activity/1" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" id="includeResult" class="form-check-input">
                                <label class="form-check-label" for="includeResult">
                                    Include Result (Score)
                                </label>
                            </div>
                        </div>
                        
                        <div id="resultSection" class="mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Score</label>
                                    <input type="number" id="resultScore" placeholder="85" min="0" max="100" class="form-control">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Max Score</label>
                                    <input type="number" id="resultMax" placeholder="100" min="1" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button type="button" id="sendXapiBtn" class="btn btn-primary w-100" onclick="sendXapiStatement()">
                                <i class="bi bi-send me-1"></i>Send xAPI Statement
                            </button>
                        </div>
                    </form>
                    
                    <!-- xAPI Response -->
                    <div id="xapiResponse" class="mt-4" style="display: none;">
                        <h6 class="fw-semibold mb-2">Response:</h6>
                        <pre class="bg-light p-3 rounded small" id="xapiResponseText"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Moodle Event Test -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Send Moodle Event</h5>
                </div>
                <div class="card-body">
                    <form id="moodleForm">
                        <div class="mb-3">
                            <label class="form-label">Event Type</label>
                            <select id="eventType" class="form-select">
                                <option value="course_viewed">course_viewed</option>
                                <option value="course_completed">course_completed</option>
                                <option value="user_loggedin">user_loggedin</option>
                                <option value="user_loggedout">user_loggedout</option>
                                <option value="quiz_attempt_submitted">quiz_attempt_submitted</option>
                                <option value="assignment_submitted">assignment_submitted</option>
                                <option value="forum_post_created">forum_post_created</option>
                                <option value="scorm_completed">scorm_completed</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">User ID</label>
                            <input type="text" id="userId" placeholder="2" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">User Name</label>
                            <input type="text" id="userName" placeholder="John Doe" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Course ID</label>
                            <input type="text" id="courseId" placeholder="3" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Course Name</label>
                            <input type="text" id="courseName" placeholder="Introduction to Psychology" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Activity ID</label>
                            <input type="text" id="activityId2" placeholder="1" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Activity Type</label>
                            <select id="activityType" class="form-select">
                                <option value="quiz">quiz</option>
                                <option value="assignment">assignment</option>
                                <option value="forum">forum</option>
                                <option value="scorm">scorm</option>
                                <option value="page">page</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Activity Name</label>
                            <input type="text" id="activityName2" placeholder="Quiz 1" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" id="includeGrade" class="form-check-input">
                                <label class="form-check-label" for="includeGrade">
                                    Include Grade
                                </label>
                            </div>
                        </div>
                        
                        <div id="gradeSection" class="mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Grade</label>
                                    <input type="number" id="grade" placeholder="85" min="0" class="form-control">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Max Grade</label>
                                    <input type="number" id="maxGrade" placeholder="100" min="1" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button type="button" id="sendMoodleBtn" class="btn btn-success w-100" onclick="sendMoodleEvent()">
                                <i class="bi bi-send me-1"></i>Send Moodle Event
                            </button>
                        </div>
                    </form>
                    
                    <!-- Moodle Response -->
                    <div id="moodleResponse" class="mt-4" style="display: none;">
                        <h6 class="fw-semibold mb-2">Response:</h6>
                        <pre class="bg-light p-3 rounded small" id="moodleResponseText"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Test Templates -->
    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h5 class="card-title mb-4">Quick Test Templates</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <button class="btn btn-outline-primary w-100 text-start p-3" onclick="useTemplate('course_completion')">
                        <h6 class="mb-1">Course Completion</h6>
                        <p class="mb-0 small text-muted">Test a completed course event</p>
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary w-100 text-start p-3" onclick="useTemplate('quiz_attempt')">
                        <h6 class="mb-1">Quiz Attempt</h6>
                        <p class="mb-0 small text-muted">Test a quiz submission with score</p>
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary w-100 text-start p-3" onclick="useTemplate('forum_post')">
                        <h6 class="mb-1">Forum Post</h6>
                        <p class="mb-0 small text-muted">Test a forum discussion post</p>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Test API JavaScript
let testData = {
    xapiTest: {
        loading: false,
        response: null,
        actor: {
            name: 'Test User',
            mbox: 'test@example.com'
        },
        verb: 'http://adlnet.gov/expapi/verbs/completed',
        activity: {
            name: 'Test Activity',
            id: 'http://example.com/activity/1'
        },
        includeResult: false,
        result: {
            score: 85,
            max: 100
        }
    },
    moodleTest: {
        loading: false,
        response: null,
        event_type: 'course_completed',
        user_id: 123,
        user_name: 'Test User',
        course_id: 1,
        course_name: 'Test Course',
        activity_id: 1,
        activity_type: 'quiz',
        activity_name: 'Test Quiz',
        includeGrade: false,
        grade: 85,
        max_grade: 100
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeForms();
    setupEventListeners();
});

// Initialize form values
function initializeForms() {
    // Set default values
    document.getElementById('actorName').value = testData.xapiTest.actor.name;
    document.getElementById('actorEmail').value = testData.xapiTest.actor.mbox;
    document.getElementById('verbSelect').value = testData.xapiTest.verb;
    document.getElementById('activityName').value = testData.xapiTest.activity.name;
    document.getElementById('activityId').value = testData.xapiTest.activity.id;
    
    document.getElementById('eventType').value = testData.moodleTest.event_type;
    document.getElementById('userId').value = testData.moodleTest.user_id;
    document.getElementById('userName').value = testData.moodleTest.user_name;
    document.getElementById('courseId').value = testData.moodleTest.course_id;
    document.getElementById('courseName').value = testData.moodleTest.course_name;
    document.getElementById('activityId2').value = testData.moodleTest.activity_id;
    document.getElementById('activityType').value = testData.moodleTest.activity_type;
    document.getElementById('activityName2').value = testData.moodleTest.activity_name;
}

// Setup event listeners
function setupEventListeners() {
    // Include result checkbox
    document.getElementById('includeResult').addEventListener('change', function() {
        const resultSection = document.getElementById('resultSection');
        resultSection.style.display = this.checked ? 'block' : 'none';
        testData.xapiTest.includeResult = this.checked;
    });
    
    // Include grade checkbox
    document.getElementById('includeGrade').addEventListener('change', function() {
        const gradeSection = document.getElementById('gradeSection');
        gradeSection.style.display = this.checked ? 'block' : 'none';
        testData.moodleTest.includeGrade = this.checked;
    });
}

// Send xAPI statement
async function sendXapiStatement() {
    const btn = document.getElementById('sendXapiBtn');
    
    testData.xapiTest.loading = true;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Sending...';
    
    try {
        // Get form values
        testData.xapiTest.actor.name = document.getElementById('actorName').value;
        testData.xapiTest.actor.mbox = document.getElementById('actorEmail').value;
        testData.xapiTest.verb = document.getElementById('verbSelect').value;
        testData.xapiTest.activity.name = document.getElementById('activityName').value;
        testData.xapiTest.activity.id = document.getElementById('activityId').value;
        
        if (testData.xapiTest.includeResult) {
            testData.xapiTest.result.score = parseInt(document.getElementById('resultScore').value) || 85;
            testData.xapiTest.result.max = parseInt(document.getElementById('resultMax').value) || 100;
        }
        
        const statement = {
            actor: {
                objectType: 'Agent',
                name: testData.xapiTest.actor.name,
                mbox: testData.xapiTest.actor.mbox
            },
            verb: {
                id: testData.xapiTest.verb,
                display: {'en-US': testData.xapiTest.verb.split('/').pop()}
            },
            object: {
                objectType: 'Activity',
                id: testData.xapiTest.activity.id,
                definition: {
                    name: {'en-US': testData.xapiTest.activity.name}
                }
            }
        };
        
        if (testData.xapiTest.includeResult) {
            statement.result = {
                score: {
                    raw: testData.xapiTest.result.score,
                    max: testData.xapiTest.result.max,
                    scaled: testData.xapiTest.result.score / testData.xapiTest.result.max
                },
                completion: true,
                success: testData.xapiTest.result.score >= (testData.xapiTest.result.max * 0.7)
            };
        }
        
        const response = await fetch('/api/xapi/statements', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(statement)
        });
        
        testData.xapiTest.response = await response.json();
        showXapiResponse();
        
    } catch (error) {
        testData.xapiTest.response = { error: error.message };
        showXapiResponse();
    } finally {
        testData.xapiTest.loading = false;
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send me-1"></i>Send xAPI Statement';
    }
}

// Send Moodle event
async function sendMoodleEvent() {
    const btn = document.getElementById('sendMoodleBtn');
    
    testData.moodleTest.loading = true;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Sending...';
    
    try {
        // Get form values
        testData.moodleTest.event_type = document.getElementById('eventType').value;
        testData.moodleTest.user_id = document.getElementById('userId').value;
        testData.moodleTest.user_name = document.getElementById('userName').value;
        testData.moodleTest.course_id = document.getElementById('courseId').value;
        testData.moodleTest.course_name = document.getElementById('courseName').value;
        testData.moodleTest.activity_id = document.getElementById('activityId2').value;
        testData.moodleTest.activity_type = document.getElementById('activityType').value;
        testData.moodleTest.activity_name = document.getElementById('activityName2').value;
        
        if (testData.moodleTest.includeGrade) {
            testData.moodleTest.grade = parseInt(document.getElementById('grade').value) || 85;
            testData.moodleTest.max_grade = parseInt(document.getElementById('maxGrade').value) || 100;
        }
        
        const event = {
            event_type: testData.moodleTest.event_type,
            user_id: testData.moodleTest.user_id,
            user_name: testData.moodleTest.user_name,
            course_id: testData.moodleTest.course_id,
            course_name: testData.moodleTest.course_name,
            activity_id: testData.moodleTest.activity_id,
            activity_type: testData.moodleTest.activity_type,
            activity_name: testData.moodleTest.activity_name,
            site_url: 'http://moodle.local'
        };
        
        if (testData.moodleTest.includeGrade) {
            event.grade = testData.moodleTest.grade;
            event.max_grade = testData.moodleTest.max_grade;
        }
        
        const response = await fetch('/api/moodle/event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(event)
        });
        
        testData.moodleTest.response = await response.json();
        showMoodleResponse();
        
    } catch (error) {
        testData.moodleTest.response = { error: error.message };
        showMoodleResponse();
    } finally {
        testData.moodleTest.loading = false;
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send me-1"></i>Send Moodle Event';
    }
}

// Show xAPI response
function showXapiResponse() {
    const responseDiv = document.getElementById('xapiResponse');
    const responseText = document.getElementById('xapiResponseText');
    
    responseDiv.style.display = 'block';
    responseText.textContent = JSON.stringify(testData.xapiTest.response, null, 2);
}

// Show Moodle response
function showMoodleResponse() {
    const responseDiv = document.getElementById('moodleResponse');
    const responseText = document.getElementById('moodleResponseText');
    
    responseDiv.style.display = 'block';
    responseText.textContent = JSON.stringify(testData.moodleTest.response, null, 2);
}

// Use template
function useTemplate(template) {
    if (template === 'course_completion') {
        document.getElementById('eventType').value = 'course_completed';
        document.getElementById('userId').value = '123';
        document.getElementById('userName').value = 'John Student';
        document.getElementById('courseId').value = '1';
        document.getElementById('courseName').value = 'Introduction to Psychology';
        document.getElementById('activityId2').value = '1';
        document.getElementById('activityType').value = 'course';
        document.getElementById('activityName2').value = 'Course Completion';
        document.getElementById('includeGrade').checked = false;
        document.getElementById('gradeSection').style.display = 'none';
    } else if (template === 'quiz_attempt') {
        document.getElementById('eventType').value = 'quiz_attempt_submitted';
        document.getElementById('userId').value = '456';
        document.getElementById('userName').value = 'Jane Smith';
        document.getElementById('courseId').value = '1';
        document.getElementById('courseName').value = 'Mathematics 101';
        document.getElementById('activityId2').value = '2';
        document.getElementById('activityType').value = 'quiz';
        document.getElementById('activityName2').value = 'Midterm Quiz';
        document.getElementById('includeGrade').checked = true;
        document.getElementById('gradeSection').style.display = 'block';
        document.getElementById('grade').value = '92';
        document.getElementById('maxGrade').value = '100';
    } else if (template === 'forum_post') {
        document.getElementById('eventType').value = 'forum_post_created';
        document.getElementById('userId').value = '789';
        document.getElementById('userName').value = 'Bob Johnson';
        document.getElementById('courseId').value = '2';
        document.getElementById('courseName').value = 'English Literature';
        document.getElementById('activityId2').value = '3';
        document.getElementById('activityType').value = 'forum';
        document.getElementById('activityName2').value = 'Weekly Discussion';
        document.getElementById('includeGrade').checked = false;
        document.getElementById('gradeSection').style.display = 'none';
    }
}
</script>
{% endblock %}
